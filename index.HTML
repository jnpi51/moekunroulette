<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>Among Us交換ルーレット</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
<meta name="color-scheme" content="dark light">
<style>
  :root{
    --bg:#0b0b0b; --panel:#141414; --line:#2a2a2a; --fg:#eee; --muted:#9aa0a6; --acc:#8ab4f8; --tap:48px;
  }
  @media (prefers-color-scheme: light) {
    :root{ --bg:#fafafa; --panel:#ffffff; --line:#ddd; --fg:#111; --muted:#667085; --acc:#2563eb; }
  }

  html,body{background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0}
  .wrap{max-width:980px;margin:0 auto;padding:calc(env(safe-area-inset-top,0) + 12px) 12px calc(env(safe-area-inset-bottom,0) + 16px)}
  h1{font-size:clamp(18px,2.4vw,22px);margin:0 0 8px}
  .row{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px;margin:12px 0}
  .grid{display:grid;gap:8px}
  /* グリッドは画面幅で段数が可変 */
  .grid{grid-template-columns:repeat(5,minmax(0,1fr))}
  @media (max-width:880px){ .grid{grid-template-columns:repeat(4,minmax(0,1fr))} }
  @media (max-width:640px){ .grid{grid-template-columns:repeat(3,minmax(0,1fr))} }
  @media (max-width:420px){ .grid{grid-template-columns:repeat(2,minmax(0,1fr))} }

  .chip{
    border:1px solid var(--line);border-radius:12px;padding:10px 6px;text-align:center;user-select:none;
    background:color-mix(in oklab, var(--panel), #000 7%); 
    display:flex;flex-direction:column;gap:8px; align-items:center; justify-content:center; min-height:82px;
    touch-action:manipulation;
  }
  .chip:active{transform:scale(.98)}
  .chip.sel{outline:2px solid var(--acc);box-shadow:0 0 0 2px color-mix(in oklab, var(--acc), transparent 80%) inset}
  .chip .swatch{width:22px;height:22px;border-radius:50%;border:1px solid rgba(255,255,255,.25)}
  .chip .name{font-size:13px;line-height:1}
  .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .controls .box{background:color-mix(in oklab, var(--panel), #000 7%);border:1px solid var(--line);border-radius:10px;padding:8px 10px}
  input[type="number"]{font-size:16px;background:transparent;color:var(--fg);border:1px solid var(--line);border-radius:8px;padding:10px;width:90px;min-height:var(--tap)}
  button{
    font-size:16px;background:color-mix(in oklab, var(--panel), #000 7%);color:var(--fg);
    border:1px solid var(--line);border-radius:12px;padding:10px 14px;cursor:pointer;min-height:var(--tap);
    touch-action:manipulation;
  }
  button:active{transform:scale(.98)}
  button:disabled{opacity:.55;cursor:not-allowed}
  .hint{font-size:12px;color:var(--muted)}
  .ticker{
    font-size:clamp(20px,4.5vw,28px); text-align:center; padding:18px; border:1px dashed var(--line); border-radius:12px; 
    background:color-mix(in oklab, var(--panel), #000 7%);
    min-height:64px; letter-spacing:.5px; line-height:1.3;
  }
  .result-badges{display:flex;flex-wrap:wrap;gap:8px}
  .badge{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:999px;padding:8px 12px;background:color-mix(in oklab, var(--panel), #000 7%);min-height:var(--tap)}
  .badge .sw{width:14px;height:14px;border-radius:50%;border:1px solid rgba(255,255,255,.25)}
  .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .spacer{flex:1}
  .btn-bar{display:flex;gap:8px;flex-wrap:wrap}
  .small{font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Among Us交換ルーレット</h1>

  <!-- 色選択 -->
  <div class="row" id="row-select">
    <div class="flex" style="margin-bottom:6px">
      <div class="hint">参加させる色をタップして選択 もう一度タップで解除</div>
      <div class="spacer"></div>
      <div class="hint">選択中 <span id="selCount">0</span> 人</div>
    </div>
    <div class="btn-bar" style="margin-bottom:8px">
      <button id="selectAllBtn">全選択</button>
      <button id="clearAllBtn">全解除</button>
      <button id="invertBtn">反転</button>
    </div>
    <div id="colorGrid" class="grid" aria-label="色の選択グリッド"></div>
  </div>

  <!-- 設定 -->
  <div class="row" id="row-config">
    <div class="controls">
      <div class="box">交換人数 <input id="numPick" type="number" inputmode="numeric" min="1" value="1" aria-label="交換人数"></div>
      <div class="spacer"></div>
      <div class="btn-bar">
        <button id="spinBtn">ルーレット開始</button>
        <button id="resetBtn">結果をリセット</button>
      </div>
    </div>
    <div class="hint" style="margin-top:6px">
      ルーレットは重複なしで順に確定 複数名を選ぶ場合は自動で連続抽選
    </div>
  </div>

  <!-- ルーレット表示 -->
  <div class="row" id="row-roulette">
    <div id="ticker" class="ticker" role="status" aria-live="polite">ここにルーレット結果が流れます</div>
  </div>

  <!-- 結果 -->
  <div class="row" id="row-result">
    <div class="flex">
      <div>交換対象 確定順</div>
      <div class="spacer"></div>
      <div class="btn-bar">
        <button id="copyBtn" title="結果をテキストとしてコピー">結果をコピー</button>
        <button id="shareBtn" title="共有">共有</button>
      </div>
    </div>
    <div id="result" class="result-badges" style="margin-top:10px"></div>
    <div class="small hint" id="copyNote" style="margin-top:6px; display:none">コピーしました</div>
  </div>

  <div class="row">
    <div class="hint">
      ブラウザ内でのみ動作し選択状態は端末に保存 iOSやAndroidのホーム画面に追加しても使用可
    </div>
  </div>
</div>

<script>
/* ===== 指定色リスト ===== */
const COLORS = [
  { id:0,  name:"赤",     hex:"#c51111" },
  { id:1,  name:"青",     hex:"#132ed1" },
  { id:2,  name:"緑",     hex:"#117f2d" },
  { id:3,  name:"ピンク", hex:"#ed54ba" },
  { id:4,  name:"オレンジ", hex:"#f07d0d" },
  { id:5,  name:"黄",     hex:"#f6f657" },
  { id:6,  name:"黒",     hex:"#3f484e" },
  { id:7,  name:"白",     hex:"#d6e0f0" },
  { id:8,  name:"紫",     hex:"#6b2fbc" },
  { id:9,  name:"茶",     hex:"#72491e" },
  { id:10, name:"水色",   hex:"#38fedc" },
  { id:11, name:"ライム", hex:"#50ef39" },
  { id:12, name:"マルーン", hex:"#6b0000" },
  { id:13, name:"ローズ", hex:"#ff79a8" },
  { id:14, name:"バナナ", hex:"#ffe89d" },
  { id:15, name:"グレー", hex:"#8391a0" },
  { id:16, name:"タン",   hex:"#b18e5f" },
  { id:17, name:"コーラル", hex:"#ff6b6b" }
];

/* ===== 状態 ===== */
let selectedIds = loadSelections();
let results = []; // {id,name,hex}
let spinning = false;

/* ===== DOM ===== */
const grid = document.getElementById('colorGrid');
const selCountEl = document.getElementById('selCount');
const numPickEl = document.getElementById('numPick');
const spinBtn = document.getElementById('spinBtn');
const resetBtn = document.getElementById('resetBtn');
const ticker = document.getElementById('ticker');
const resultBox = document.getElementById('result');
const copyBtn = document.getElementById('copyBtn');
const shareBtn = document.getElementById('shareBtn');
const copyNote = document.getElementById('copyNote');
const selectAllBtn = document.getElementById('selectAllBtn');
const clearAllBtn = document.getElementById('clearAllBtn');
const invertBtn = document.getElementById('invertBtn');

/* ===== 初期描画 ===== */
renderGrid();
updateSelCount();
renderResults();
adjustNumPickMax();

/* ===== イベント ===== */
numPickEl.addEventListener('input', adjustNumPickMax);

resetBtn.addEventListener('click', ()=>{
  if (spinning) return;
  results = [];
  ticker.textContent = 'ここにルーレット結果が流れます';
  renderResults();
  vibrate(10);
});

copyBtn.addEventListener('click', ()=>{
  const text = resultText();
  copyToClipboard(text).then(()=>{
    copyNote.style.display = 'block';
    setTimeout(()=>copyNote.style.display='none', 1200);
    vibrate(10);
  });
});

shareBtn.addEventListener('click', async ()=>{
  const text = resultText();
  if (navigator.share) {
    try { await navigator.share({ text }); }
    catch(e) {}
  } else {
    await copyToClipboard(text);
    copyNote.style.display = 'block';
    setTimeout(()=>copyNote.style.display='none', 1200);
  }
  vibrate(10);
});

selectAllBtn.addEventListener('click', ()=>{
  selectedIds = COLORS.map(c=>c.id);
  saveSelections(); renderGrid(); updateSelCount(); adjustNumPickMax(); vibrate(10);
});
clearAllBtn.addEventListener('click', ()=>{
  selectedIds = [];
  saveSelections(); renderGrid(); updateSelCount(); adjustNumPickMax(); vibrate(10);
});
invertBtn.addEventListener('click', ()=>{
  const set = new Set(selectedIds);
  selectedIds = COLORS.map(c=>c.id).filter(id=>!set.has(id));
  saveSelections(); renderGrid(); updateSelCount(); adjustNumPickMax(); vibrate(10);
});

spinBtn.addEventListener('click', async ()=>{
  if (spinning) return;
  const nPick = clamp(parseInt(numPickEl.value||'1',10), 1, 100);
  const pool = COLORS.filter(c=>selectedIds.includes(c.id) && !results.some(r=>r.id===c.id));
  if (pool.length <= 0) { ticker.textContent = '選択中の候補がありません'; vibrate(30); return; }
  if (nPick > pool.length) { ticker.textContent = `候補が不足 残り ${pool.length} 人`; vibrate(30); return; }

  spinning = true;
  spinBtn.disabled = true;

  try{
    for(let k=0;k<nPick;k++){
      const rest = COLORS.filter(c=>selectedIds.includes(c.id) && !results.some(r=>r.id===c.id));
      const winner = await spinOnce(rest);
      results.push(winner);
      renderResults();
      await sleep(300);
    }
  } finally {
    spinning = false;
    spinBtn.disabled = false;
    vibrate(20);
  }
});

/* ===== 関数群 ===== */
function renderGrid(){
  grid.innerHTML = '';
  COLORS.forEach(c=>{
    const div = document.createElement('button');
    div.type = 'button';
    div.className = 'chip' + (selectedIds.includes(c.id)?' sel':'');
    div.setAttribute('data-id', String(c.id));
    div.setAttribute('aria-pressed', selectedIds.includes(c.id) ? 'true' : 'false');
    div.innerHTML = `
      <div class="swatch" style="background:${c.hex}"></div>
      <div class="name">${c.name}</div>
    `;
    // タップで選択切替
    div.addEventListener('click', ()=>{
      if (spinning) return;
      toggleSelect(c.id);
      const on = selectedIds.includes(c.id);
      div.classList.toggle('sel', on);
      div.setAttribute('aria-pressed', on ? 'true' : 'false');
      updateSelCount();
      adjustNumPickMax();
      saveSelections();
      vibrate(8);
    }, {passive:true});
    grid.appendChild(div);
  });
}

function toggleSelect(id){
  const i = selectedIds.indexOf(id);
  if (i>=0) selectedIds.splice(i,1);
  else selectedIds.push(id);
}

function updateSelCount(){
  selCountEl.textContent = String(selectedIds.length);
}

function adjustNumPickMax(){
  const remain = COLORS.filter(c=>selectedIds.includes(c.id) && !results.some(r=>r.id===c.id)).length;
  const cur = parseInt(numPickEl.value||'1',10);
  if (remain<=0){ numPickEl.value = 1; return; }
  if (cur>remain) numPickEl.value = remain;
  numPickEl.max = remain;
  numPickEl.min = 1;
}

function renderResults(){
  resultBox.innerHTML = '';
  results.forEach((r,idx)=>{
    const el = document.createElement('div');
    el.className = 'badge';
    el.innerHTML = `<span>${idx+1}.</span><span class="sw" style="background:${r.hex}"></span><span>${r.name}</span>`;
    resultBox.appendChild(el);
  });
  adjustNumPickMax();
}

function resultText(){
  const lines = results.map((r,i)=>`${i+1}. ${r.name}`);
  return lines.join('\n') || '結果なし';
}

// ルーレット一回
async function spinOnce(candidates){
  const duration = 1400 + Math.random()*700;  // 軽量化
  const tick = 55;
  const endTime = performance.now() + duration;
  let lastIdx = -1;

  while(performance.now() < endTime){
    const i = Math.floor(Math.random()*candidates.length);
    if (i!==lastIdx){
      const c = candidates[i];
      ticker.innerHTML = `抽選中… <b>${c.name}</b>`;
      lastIdx = i;
    }
    await sleep(tick);
  }

  const winner = candidates[Math.floor(Math.random()*candidates.length)];
  ticker.innerHTML = `確定: <b style="font-size:120%">${winner.name}</b>`;
  flashTicker(winner.hex);
  vibrate(30);
  return winner;
}

function flashTicker(color){
  ticker.style.transition = 'background 0.15s ease';
  ticker.style.backgroundColor = hexWithAlpha(color, 0.28);
  setTimeout(()=>{ ticker.style.backgroundColor = ''; }, 200);
}

function hexWithAlpha(hex, alpha){
  const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
  if (!m) return `rgba(255,255,255,${alpha})`;
  const r=parseInt(m[1],16), g=parseInt(m[2],16), b=parseInt(m[3],16);
  return `rgba(${r},${g},${b},${alpha})`;
}

function sleep(ms){ return new Promise(res=>setTimeout(res,ms)); }
function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

/* クリップボード iOS 対応 */
async function copyToClipboard(text){
  try{
    if (navigator.clipboard && window.isSecureContext) {
      await navigator.clipboard.writeText(text);
      return;
    }
  }catch(e){}
  // フォールバック
  const ta = document.createElement('textarea');
  ta.value = text;
  ta.style.position='fixed';
  ta.style.opacity='0';
  document.body.appendChild(ta);
  ta.focus();
  ta.select();
  try{ document.execCommand('copy'); } catch(e){}
  document.body.removeChild(ta);
}

/* Haptics */
function vibrate(ms){
  try{ if (navigator.vibrate) navigator.vibrate(ms); }catch(e){}
}

/* 保存 */
function saveSelections(){
  try{ localStorage.setItem('au_roulette_selected', JSON.stringify(selectedIds)); }catch(e){}
}
function loadSelections(){
  try{
    const s = localStorage.getItem('au_roulette_selected');
    if (!s) return [];
    const arr = JSON.parse(s);
    if (Array.isArray(arr)) return arr.filter(x=>typeof x==='number');
  }catch(e){}
  return [];
}
</script>
</body>
</html>